<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crypto Hub — в стиле CoinGecko</title>
  <meta name="description" content="Лёгкий, независимый крипто-дэшборд с данными CoinGecko и графиками TradingView"/>
  <link rel="preconnect" href="https://api.coingecko.com"/>
  <link rel="preconnect" href="https://s3.tradingview.com"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* ===== CSS Variables ===== */
    :root {
      --bg: #0f131a;
      --card: #151a23;
      --text: #e7ecf3;
      --muted: #a8b0bd;
      --accent: #4cc9f0;
      --accent-2: #00e1a5;
      --red: #ff6b6b;
      --green: #2ecc71;
      --border: #232a35;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --table-even: #131821;
      --link: #9dd8ff;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --radius: 12px;
      --gradient: linear-gradient(135deg, var(--accent), var(--accent-2));
    }
    
    [data-theme="light"] {
      --bg: #f7f9fc;
      --card: #ffffff;
      --text: #111827;
      --muted: #4b5563;
      --accent: #2563eb;
      --accent-2: #059669;
      --red: #dc2626;
      --green: #16a34a;
      --border: #e5e7eb;
      --shadow: 0 6px 16px rgba(0,0,0,0.12);
      --table-even: #f3f4f6;
      --link: #1d4ed8;
    }
    
    /* ===== Reset ===== */
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body { 
      height: 100%;
      scroll-behavior: smooth;
    }
    
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
      transition: background-color 0.3s ease;
    }
    
    /* ===== Header ===== */
    header {
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: saturate(180%) blur(20px);
      background: rgba(21, 26, 35, 0.9);
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }
    
    [data-theme="light"] header {
      background: rgba(255, 255, 255, 0.9);
    }
    
    .nav {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 20px;
      align-items: center;
      padding: 16px 24px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Brand */
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .brand:hover {
      transform: translateY(-2px);
    }
    
    .logo {
      width: 40px;
      height: 40px;
      border-radius: var(--radius);
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
      box-shadow: var(--shadow);
    }
    
    .brand h1 {
      font-size: 20px;
      margin: 0;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-weight: 800;
    }
    
    /* Search */
    .search-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .search-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      background: var(--table-even);
      border: 2px solid transparent;
      border-radius: var(--radius);
      padding: 8px 16px;
      transition: var(--transition);
      box-shadow: var(--shadow);
    }
    
    .search-wrapper:focus-within {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76, 201, 240, 0.2);
    }
    
    .search-wrapper input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 14px;
      padding: 4px 8px;
    }
    
    .search-wrapper input::placeholder {
      color: var(--muted);
    }
    
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: var(--shadow);
      animation: slideDown 0.2s ease;
    }
    
    /* Search Results Items */
    .search-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }
    
    .search-result-item:hover {
      background: rgba(76, 201, 240, 0.1);
    }
    
    .search-result-item img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .coin-info {
      flex: 1;
    }
    
    .coin-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .coin-symbol {
      color: var(--muted);
      font-size: 12px;
      font-weight: 500;
    }
    
    .coin-price {
      font-weight: 600;
      font-size: 14px;
    }
    
    .price-up { color: var(--green); }
    .price-down { color: var(--red); }
    
    /* ===== Stats Bar ===== */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      padding: 20px 24px;
      background: linear-gradient(90deg, rgba(76, 201, 240, 0.1) 0%, rgba(0, 225, 165, 0.1) 100%);
      border-bottom: 1px solid var(--border);
    }
    
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow);
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient);
    }
    
    .stat-label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      margin: 4px 0;
    }
    
    .stat-change {
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* ===== Controls ===== */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--table-even);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 8px 16px;
      transition: var(--transition);
    }
    
    .control-group:hover {
      border-color: var(--accent);
    }
    
    .control-group i {
      color: var(--accent);
      font-size: 14px;
    }
    
    .control-group select,
    .control-group button {
      background: transparent;
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      padding: 4px 8px;
      outline: none;
    }
    
    .control-group select option {
      background: var(--card);
      color: var(--text);
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: .4s;
      border-radius: 34px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--accent);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    /* ===== Table ===== */
    .table-container {
      position: relative;
      overflow: hidden;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card);
    }
    
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    thead th {
      padding: 16px 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      background: var(--table-even);
      border-bottom: 2px solid var(--border);
      user-select: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
    }
    
    thead th:hover {
      background: rgba(76, 201, 240, 0.1);
      color: var(--accent);
    }
    
    thead th.sort-asc::after,
    thead th.sort-desc::after {
      content: '↕';
      margin-left: 8px;
      font-size: 10px;
    }
    
    thead th.sort-asc::after {
      content: '↑';
    }
    
    thead th.sort-desc::after {
      content: '↓';
    }
    
    tbody td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }
    
    tbody tr {
      transition: var(--transition);
    }
    
    tbody tr:hover {
      background: rgba(76, 201, 240, 0.08);
      transform: translateX(4px);
    }
    
    .coin-cell {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
    }
    
    .coin-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--border);
      transition: var(--transition);
    }
    
    .coin-cell:hover .coin-icon {
      border-color: var(--accent);
      transform: scale(1.1);
    }
    
    .coin-name-symbol {
      display: flex;
      flex-direction: column;
    }
    
    /* Sparkline */
    .sparkline-container {
      width: 120px;
      height: 40px;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s;
    }
    
    .sparkline-container:hover {
      transform: scale(1.1);
    }
    
    /* Badges */
    .badges {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: var(--table-even);
      border: 1px solid var(--border);
      color: var(--muted);
      transition: var(--transition);
      cursor: default;
    }
    
    .badge:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    /* Favorite Star */
    .fav-star {
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: none;
      border: none;
      color: var(--muted);
      padding: 4px;
    }
    
    .fav-star:hover {
      transform: scale(1.3);
      color: var(--accent);
    }
    
    .fav-star.active {
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }
    
    /* ===== Pagination ===== */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px;
      background: var(--card);
      border-top: 1px solid var(--border);
    }
    
    .pagination button {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--table-even);
      color: var(--text);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
    }
    
    .pagination button:hover:not(:disabled) {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      transform: translateY(-2px);
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination-info {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--muted);
      font-size: 14px;
    }
    
    /* ===== Modal ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    .modal {
      width: min(1000px, 95vw);
      max-height: 90vh;
      overflow: hidden;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: modalSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--card);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .modal-header-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .modal-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--border);
    }
    
    .modal-title h2 {
      font-size: 24px;
      margin-bottom: 4px;
    }
    
    .modal-title p {
      color: var(--muted);
      font-size: 14px;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      transition: var(--transition);
      padding: 4px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-modal:hover {
      background: var(--table-even);
      color: var(--red);
      transform: rotate(90deg);
    }
    
    /* Modal Buttons */
    .btn {
      padding: 10px 20px;
      border: 1px solid var(--border);
      background: var(--table-even);
      color: var(--text);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      transform: translateY(-2px);
    }
    
    /* ===== Loading States ===== */
    .loading {
      position: relative;
      overflow: hidden;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: loading 1.5s infinite;
    }
    
    /* ===== Animations ===== */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    @keyframes loading {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    .slide-in-up {
      animation: slideInUp 0.6s ease forwards;
    }
    
    /* ===== Responsive Design ===== */
    @media (max-width: 1200px) {
      .nav {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .controls {
        order: 3;
      }
    }
    
    @media (max-width: 768px) {
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .modal {
        width: 95vw;
        max-height: 95vh;
      }
      
      .coin-cell {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .sparkline-container {
        display: none;
      }
      
      .modal-header-content {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    @media (max-width: 480px) {
      .stats {
        grid-template-columns: 1fr;
      }
      
      .control-group {
        width: 100%;
        justify-content: space-between;
      }
      
      .modal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      
      .close-modal {
        position: absolute;
        top: 20px;
        right: 20px;
      }
    }
    
    /* ===== Custom Scrollbar ===== */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--table-even);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-2);
    }
    
    /* ===== Tooltip ===== */
    [data-tooltip] {
      position: relative;
    }
    
    [data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
      border: 1px solid var(--border);
      z-index: 1000;
    }
    
    [data-tooltip]::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: var(--card);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }
    
    [data-tooltip]:hover::before,
    [data-tooltip]:hover::after {
      opacity: 1;
      visibility: visible;
    }
    
    /* ===== Notification ===== */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 9999;
      animation: slideInUp 0.3s ease;
      box-shadow: var(--shadow);
    }
    
    .notification.success {
      background: var(--green);
      color: white;
    }
    
    .notification.error {
      background: var(--red);
      color: white;
    }
    
    .notification.info {
      background: var(--accent);
      color: white;
    }
  </style>
</head>
<body data-theme="dark">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="logo">CH</div>
    <h2 style="margin-bottom: 10px; color: var(--accent);">Crypto Hub</h2>
    <p style="color: var(--muted); margin-bottom: 30px;">Загрузка данных...</p>
    <div style="width: 200px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden;">
      <div id="loadingBar" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.3s ease;"></div>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="nav">
      <div class="brand" onclick="scrollToTop()">
        <div class="logo">CH</div>
        <h1>Crypto Hub</h1>
        <span class="badge" id="langBadge">RU</span>
      </div>

      <div class="search-container">
        <div class="search-wrapper">
          <i class="fas fa-search" style="color: var(--muted);"></i>
          <input 
            type="text" 
            id="search" 
            placeholder="Поиск по названию или символу..." 
            autocomplete="off"
          />
          <div class="search-results" id="searchResults"></div>
        </div>
      </div>

      <div class="controls">
        <div class="control-group">
          <i class="fas fa-sort-amount-down"></i>
          <select id="sort">
            <option value="market_cap_desc">Капитализация ↓</option>
            <option value="market_cap_asc">Капитализация ↑</option>
            <option value="volume_desc">Объём ↓</option>
            <option value="volume_asc">Объём ↑</option>
            <option value="price_desc">Цена ↓</option>
            <option value="price_asc">Цена ↑</option>
            <option value="change_desc">Изм. 24ч ↓</option>
            <option value="change_asc">Изм. 24ч ↑</option>
          </select>
        </div>

        <div class="control-group">
          <i class="fas fa-palette"></i>
          <button id="toggleTheme">Тема</button>
        </div>

        <div class="control-group">
          <i class="fas fa-star"></i>
          <label class="toggle-switch">
            <input type="checkbox" id="favOnly">
            <span class="toggle-slider"></span>
          </label>
          <span style="font-size: 14px;">Избранное</span>
        </div>

        <div class="control-group">
          <i class="fas fa-language"></i>
          <select id="language">
            <option value="ru">Русский</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Global Stats -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-chart-pie"></i>
          Рынок
        </div>
        <div class="stat-value" id="statDominance">—</div>
        <div class="stat-change" id="marketChange24h">—</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-dollar-sign"></i>
          Капитализация
        </div>
        <div class="stat-value" id="statMarketCap">—</div>
        <div class="stat-change" id="mcapChange24h">—</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-chart-line"></i>
          24ч объём
        </div>
        <div class="stat-value" id="statVolume">—</div>
        <div class="stat-change" id="volumeChange24h">—</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">
          <i class="fas fa-coins"></i>
          Монеты
        </div>
        <div class="stat-value" id="statCount">—</div>
        <div class="stat-change" id="coinsChange24h">—</div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container" style="max-width: 1400px; margin: 24px auto; padding: 0 20px;">
    <div class="table-container">
      <table id="coinsTable">
        <thead>
          <tr>
            <th data-sort="rank">#</th>
            <th data-sort="name">Монета</th>
            <th data-sort="price">Цена</th>
            <th data-sort="change">24ч</th>
            <th data-sort="market_cap">Капитализация</th>
            <th data-sort="volume">Объём 24ч</th>
            <th>График 7д</th>
            <th>Теги</th>
            <th><i class="fas fa-star"></i></th>
          </tr>
        </thead>
        <tbody id="coinsBody">
          <!-- Data will be loaded via JS -->
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px;">
              <div class="loading" style="height: 40px; border-radius: 8px;"></div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination">
        <button id="firstPage" title="Первая страница">
          <i class="fas fa-angle-double-left"></i>
        </button>
        <button id="prevPage">
          <i class="fas fa-chevron-left"></i> Назад
        </button>
        
        <div class="pagination-info">
          <span id="pageInfo">Страница 1 из 1</span>
          <span>•</span>
          <span id="totalCoins">0 монет</span>
        </div>
        
        <button id="nextPage">
          Вперёд <i class="fas fa-chevron-right"></i>
        </button>
        <button id="lastPage" title="Последняя страница">
          <i class="fas fa-angle-double-right"></i>
        </button>
      </div>
    </div>
  </main>

  <!-- Modal Window -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-header-content">
          <img id="modalIcon" src="" alt="" class="modal-icon">
          <div class="modal-title">
            <h2 id="modalTitle">Bitcoin (BTC)</h2>
            <p id="modalSymbol">#1 • Криптовалюта</p>
          </div>
        </div>
        <button class="close-modal" id="closeModal">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div style="padding: 24px; overflow-y: auto; max-height: calc(90vh - 140px);">
        <!-- Quick Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
          <div class="stat-card">
            <div class="stat-label">
              <i class="fas fa-dollar-sign"></i>
              Цена
            </div>
            <div class="stat-value" id="mPrice">—</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">
              <i class="fas fa-chart-line"></i>
              24ч изменение
            </div>
            <div class="stat-value" id="mChange">—</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">
              <i class="fas fa-landmark"></i>
              Капитализация
            </div>
            <div class="stat-value" id="mCap">—</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">
              <i class="fas fa-chart-bar"></i>
              Объём 24ч
            </div>
            <div class="stat-value" id="mVol">—</div>
          </div>
        </div>

        <!-- Details and Chart -->
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;">
          <div class="stat-card">
            <div class="stat-label">
              <i class="fas fa-info-circle"></i>
              Детали
            </div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;">
              <div>
                <div style="color: var(--muted); font-size: 12px; margin-bottom: 4px;">Ранг</div>
                <div id="mRank" style="font-weight: 600;">—</div>
              </div>
              <div>
                <div style="color: var(--muted); font-size: 12px; margin-bottom: 4px;">Поставка</div>
                <div id="mSupply" style="font-weight: 600;">—</div>
              </div>
              <div>
                <div style="color: var(--muted); font-size: 12px; margin-bottom: 4px;">Макс. поставка</div>
                <div id="mMaxSupply" style="font-weight: 600;">—</div>
              </div>
              <div>
                <div style="color: var(--muted); font-size: 12px; margin-bottom: 4px;">ATH</div>
                <div id="mAth" style="font-weight: 600;">—</div>
              </div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label">
              <i class="fas fa-chart-area"></i>
              График
            </div>
            <div id="tvWidget" style="height: 200px; margin-top: 12px;"></div>
          </div>
        </div>

        <!-- Description -->
        <div class="stat-card">
          <div class="stat-label">
            <i class="fas fa-align-left"></i>
            Описание
          </div>
          <div id="mDescription" style="margin-top: 12px; line-height: 1.6; max-height: 200px; overflow-y: auto; padding-right: 8px;">
            <div class="loading" style="height: 100px; border-radius: 8px;"></div>
          </div>
        </div>

        <!-- Links -->
        <div class="stat-card">
          <div class="stat-label">
            <i class="fas fa-link"></i>
            Ссылки
          </div>
          <div id="mLinks" style="margin-top: 12px; display: flex; gap: 12px; flex-wrap: wrap;">
            <div class="loading" style="height: 40px; width: 100px; border-radius: 8px;"></div>
          </div>
        </div>
      </div>

      <!-- Modal Actions -->
      <div style="padding: 20px 24px; border-top: 1px solid var(--border); display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn" id="modalFavToggle">
          <i class="fas fa-star"></i> В избранное
        </button>
        <button class="btn" id="openOnCG">
          <i class="fas fa-external-link-alt"></i> CoinGecko
        </button>
        <button class="btn" id="copySymbol">
          <i class="fas fa-copy"></i> Тикер
        </button>
        <button class="btn" id="modalTheme">
          <i class="fas fa-moon"></i> Тема графика
        </button>
        <button class="btn" id="modalRefresh" style="background: var(--accent); color: white;">
          <i class="fas fa-sync-alt"></i> Обновить
        </button>
      </div>
    </div>
  </div>

  <!-- TradingView Script -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  
  <script>
  // ===== MAIN APPLICATION =====
  (function() {
    'use strict';
    
    // ===== STATE MANAGEMENT =====
    const state = {
      coins: [],
      filteredCoins: [],
      favorites: new Set(JSON.parse(localStorage.getItem('cryptoHubFavorites') || '[]')),
      theme: localStorage.getItem('cryptoHubTheme') || 'dark',
      language: localStorage.getItem('cryptoHubLanguage') || 'ru',
      sortBy: localStorage.getItem('cryptoHubSort') || 'market_cap_desc',
      showFavorites: localStorage.getItem('cryptoHubShowFav') === 'true',
      pageSize: 50,
      currentPage: 1,
      searchQuery: '',
      lastUpdate: null,
      globalStats: null,
      currentModalCoin: null,
      chartTheme: 'dark',
      isLoading: false,
      apiCache: new Map(),
      lastApiCall: 0,
      apiRateLimit: 10000, // 10 секунд между вызовами
      tvWidget: null
    };
    
    // ===== DOM ELEMENTS =====
    const elements = {
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingBar: document.getElementById('loadingBar'),
      search: document.getElementById('search'),
      searchResults: document.getElementById('searchResults'),
      sort: document.getElementById('sort'),
      favOnly: document.getElementById('favOnly'),
      language: document.getElementById('language'),
      toggleTheme: document.getElementById('toggleTheme'),
      coinsBody: document.getElementById('coinsBody'),
      firstPage: document.getElementById('firstPage'),
      prevPage: document.getElementById('prevPage'),
      nextPage: document.getElementById('nextPage'),
      lastPage: document.getElementById('lastPage'),
      pageInfo: document.getElementById('pageInfo'),
      totalCoins: document.getElementById('totalCoins'),
      statDominance: document.getElementById('statDominance'),
      statMarketCap: document.getElementById('statMarketCap'),
      statVolume: document.getElementById('statVolume'),
      statCount: document.getElementById('statCount'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      closeModal: document.getElementById('closeModal'),
      modalTitle: document.getElementById('modalTitle'),
      modalIcon: document.getElementById('modalIcon'),
      modalSymbol: document.getElementById('modalSymbol'),
      mPrice: document.getElementById('mPrice'),
      mChange: document.getElementById('mChange'),
      mCap: document.getElementById('mCap'),
      mVol: document.getElementById('mVol'),
      mRank: document.getElementById('mRank'),
      mSupply: document.getElementById('mSupply'),
      mMaxSupply: document.getElementById('mMaxSupply'),
      mAth: document.getElementById('mAth'),
      mDescription: document.getElementById('mDescription'),
      mLinks: document.getElementById('mLinks'),
      tvWidget: document.getElementById('tvWidget'),
      modalFavToggle: document.getElementById('modalFavToggle'),
      openOnCG: document.getElementById('openOnCG'),
      copySymbol: document.getElementById('copySymbol'),
      modalTheme: document.getElementById('modalTheme'),
      modalRefresh: document.getElementById('modalRefresh')
    };
    
    // ===== LOCALIZATION =====
    const texts = {
      ru: {
        loading: 'Загрузка...',
        searchPlaceholder: 'Поиск по названию или символу...',
        noResults: 'Ничего не найдено',
        marketCap: 'Капитализация',
        volume: 'Объём 24ч',
        price: 'Цена',
        change24h: '24ч',
        favorite: 'Избранное',
        page: 'Страница',
        of: 'из',
        coins: 'монет',
        lastUpdate: 'Обновлено',
        error: 'Ошибка',
        retry: 'Повторить',
        loadingError: 'Ошибка загрузки данных',
        apiLimit: 'Превышен лимит запросов',
        favoritesEmpty: 'В избранном ничего нет',
        addToFavorites: 'В избранное',
        removeFromFavorites: 'Убрать из избранного',
        copied: 'Скопировано!',
        copyError: 'Не удалось скопировать',
        darkTheme: 'Тёмная тема',
        lightTheme: 'Светлая тема',
        updated: 'Обновлено',
        rank: 'Ранг',
        supply: 'Поставка',
        maxSupply: 'Макс. поставка',
        ath: 'Исторический максимум'
      },
      en: {
        loading: 'Loading...',
        searchPlaceholder: 'Search by name or symbol...',
        noResults: 'No results found',
        marketCap: 'Market Cap',
        volume: '24h Volume',
        price: 'Price',
        change24h: '24h',
        favorite: 'Favorite',
        page: 'Page',
        of: 'of',
        coins: 'coins',
        lastUpdate: 'Updated',
        error: 'Error',
        retry: 'Retry',
        loadingError: 'Error loading data',
        apiLimit: 'Rate limit exceeded',
        favoritesEmpty: 'No favorites yet',
        addToFavorites: 'Add to favorites',
        removeFromFavorites: 'Remove from favorites',
        copied: 'Copied!',
        copyError: 'Failed to copy',
        darkTheme: 'Dark theme',
        lightTheme: 'Light theme',
        updated: 'Updated',
        rank: 'Rank',
        supply: 'Supply',
        maxSupply: 'Max Supply',
        ath: 'All Time High'
      }
    };
    
    // ===== FORMATTERS =====
    const formatter = {
      currency(value, currency = 'USD') {
        if (value === null || value === undefined || isNaN(value)) return '—';
        return new Intl.NumberFormat(state.language === 'ru' ? 'ru-RU' : 'en-US', {
          style: 'currency',
          currency: currency,
          minimumFractionDigits: value < 1 ? 6 : 2,
          maximumFractionDigits: value < 1 ? 6 : 2
        }).format(value);
      },
      
      number(value, decimals = 0) {
        if (value === null || value === undefined || isNaN(value)) return '—';
        return new Intl.NumberFormat(state.language === 'ru' ? 'ru-RU' : 'en-US', {
          maximumFractionDigits: decimals
        }).format(value);
      },
      
      percentage(value) {
        if (value === null || value === undefined || isNaN(value)) return '—';
        const formatted = Math.abs(value).toFixed(2);
        return `${value > 0 ? '+' : ''}${formatted}%`;
      },
      
      compactNumber(value) {
        if (value === null || value === undefined || isNaN(value)) return '—';
        const formatter = new Intl.NumberFormat('en-US', {
          notation: 'compact',
          compactDisplay: 'short'
        });
        return formatter.format(value);
      },
      
      dateTime(date) {
        if (!date) return '—';
        return new Date(date).toLocaleString(state.language === 'ru' ? 'ru-RU' : 'en-US');
      }
    };
    
    // ===== API SERVICE =====
    const apiService = {
      baseUrl: 'https://api.coingecko.com/api/v3',
      
      async request(endpoint, cacheKey = null) {
        // Check cache
        if (cacheKey && state.apiCache.has(cacheKey)) {
          const cached = state.apiCache.get(cacheKey);
          if (Date.now() - cached.timestamp < 300000) { // 5 minutes cache
            return cached.data;
          }
        }
        
        // Rate limiting
        const now = Date.now();
        if (now - state.lastApiCall < state.apiRateLimit) {
          await new Promise(resolve => setTimeout(resolve, state.apiRateLimit - (now - state.lastApiCall)));
        }
        
        try {
          state.lastApiCall = Date.now();
          console.log(`API Request: ${endpoint}`);
          
          const response = await fetch(`${this.baseUrl}${endpoint}`, {
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const data = await response.json();
          
          // Cache response
          if (cacheKey) {
            state.apiCache.set(cacheKey, {
              data,
              timestamp: Date.now()
            });
          }
          
          return data;
        } catch (error) {
          console.error('API Error:', error);
          showNotification(texts[state.language].apiLimit, 'error');
          throw error;
        }
      },
      
      async getMarkets(params = {}) {
        const query = new URLSearchParams({
          vs_currency: 'usd',
          order: 'market_cap_desc',
          per_page: 250,
          page: 1,
          sparkline: true,
          price_change_percentage: '1h,24h,7d',
          ...params
        });
        
        return this.request(`/coins/markets?${query}`, `markets_${query}`);
      },
      
      async getGlobalStats() {
        return this.request('/global', 'global');
      },
      
      async getCoinDetails(id) {
        return this.request(
          `/coins/${id}?localization=false&tickers=false&community_data=false&developer_data=false&sparkline=false`, 
          `coin_${id}`
        );
      }
    };
    
    // ===== CORE FUNCTIONS =====
    
    async function init() {
      try {
        showLoading(0);
        
        // Apply saved settings
        applyTheme(state.theme);
        applyLanguage(state.language);
        
        // Load initial data
        showLoading(30);
        await Promise.all([
          loadGlobalStats(),
          loadCoins()
        ]);
        
        showLoading(90);
        applyFilters();
        
        // Hide loading screen
        showLoading(100);
        setTimeout(() => {
          elements.loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            elements.loadingOverlay.style.display = 'none';
          }, 300);
        }, 500);
        
        // Setup auto-refresh
        setInterval(refreshData, 60000);
        
        showNotification('Данные загружены успешно', 'success');
        
      } catch (error) {
        console.error('Initialization error:', error);
        showNotification('Ошибка загрузки данных', 'error');
      }
    }
    
    function showLoading(percent) {
      elements.loadingBar.style.width = `${percent}%`;
    }
    
    function applyTheme(theme) {
      state.theme = theme;
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('cryptoHubTheme', theme);
      
      // Update theme button text
      const t = texts[state.language];
      elements.toggleTheme.textContent = theme === 'dark' ? t.lightTheme : t.darkTheme;
    }
    
    function applyLanguage(lang) {
      state.language = lang;
      localStorage.setItem('cryptoHubLanguage', lang);
      document.documentElement.lang = lang;
      
      // Update UI texts
      updateTexts();
    }
    
    function updateTexts() {
      const t = texts[state.language];
      
      elements.search.placeholder = t.searchPlaceholder;
      elements.favOnly.nextElementSibling.textContent = t.favorite;
      elements.toggleTheme.textContent = state.theme === 'dark' ? t.lightTheme : t.darkTheme;
      
      // Update table headers
      const headers = document.querySelectorAll('thead th');
      if (headers[1]) headers[1].textContent = t.favorite;
      
      // Update modal labels
      document.querySelectorAll('[data-label]').forEach(el => {
        const key = el.dataset.label;
        if (t[key]) el.textContent = t[key];
      });
    }
    
    async function loadGlobalStats() {
      try {
        const data = await apiService.getGlobalStats();
        state.globalStats = data.data;
        
        // Update DOM
        elements.statDominance.textContent = 
          `BTC ${(data.data.market_cap_percentage.btc || 0).toFixed(1)}%`;
        elements.statMarketCap.textContent = 
          formatter.currency(data.data.total_market_cap.usd);
        elements.statVolume.textContent = 
          formatter.currency(data.data.total_volume.usd);
        elements.statCount.textContent = 
          formatter.number(data.data.active_cryptocurrencies);
        
      } catch (error) {
        console.error('Error loading global stats:', error);
      }
    }
    
    async function loadCoins() {
      try {
        state.isLoading = true;
        
        const data = await apiService.getMarkets({
          order: state.sortBy.replace('_asc', '_desc').replace('_desc', '_desc')
        });
        
        state.coins = data.map(coin => ({
          ...coin,
          symbol: coin.symbol.toUpperCase()
        }));
        
        state.lastUpdate = Date.now();
        
      } catch (error) {
        console.error('Error loading coins:', error);
        throw error;
      } finally {
        state.isLoading = false;
      }
    }
    
    function applyFilters() {
      let filtered = [...state.coins];
      
      // Search filter
      if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        filtered = filtered.filter(coin => 
          coin.name.toLowerCase().includes(query) ||
          coin.symbol.toLowerCase().includes(query)
        );
      }
      
      // Favorites filter
      if (state.showFavorites) {
        filtered = filtered.filter(coin => state.favorites.has(coin.id));
      }
      
      // Sorting
      filtered.sort((a, b) => {
        const getValue = (coin, key) => {
          switch (key) {
            case 'rank': return coin.market_cap_rank || Infinity;
            case 'name': return coin.name.toLowerCase();
            case 'price': return coin.current_price || 0;
            case 'change': return coin.price_change_percentage_24h || 0;
            case 'market_cap': return coin.market_cap || 0;
            case 'volume': return coin.total_volume || 0;
            default: return coin.market_cap || 0;
          }
        };
        
        const [key, direction] = state.sortBy.split('_');
        const aValue = getValue(a, key);
        const bValue = getValue(b, key);
        
        if (direction === 'asc') {
          return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;
        } else {
          return bValue < aValue ? -1 : bValue > aValue ? 1 : 0;
        }
      });
      
      state.filteredCoins = filtered;
      renderTable();
      updatePagination();
    }
    
    function renderTable() {
      const start = (state.currentPage - 1) * state.pageSize;
      const end = start + state.pageSize;
      const coinsToShow = state.filteredCoins.slice(start, end);
      const t = texts[state.language];
      
      if (coinsToShow.length === 0) {
        elements.coinsBody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 60px 20px;">
              <div style="color: var(--muted);">
                <i class="fas fa-${state.showFavorites ? 'star' : 'search'}" 
                   style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                <h3 style="margin-bottom: 8px;">${t.noResults}</h3>
                ${state.showFavorites ? `<p>${t.favoritesEmpty}</p>` : ''}
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      elements.coinsBody.innerHTML = coinsToShow.map((coin, index) => {
        const isFavorite = state.favorites.has(coin.id);
        const change24h = coin.price_change_percentage_24h || 0;
        const changeClass = change24h >= 0 ? 'price-up' : 'price-down';
        const sparkline = createSparkline(coin.sparkline_in_7d?.price || []);
        
        return `
          <tr data-coin-id="${coin.id}" 
              class="slide-in-up" 
              style="animation-delay: ${index * 0.05}s;">
            <td>${coin.market_cap_rank || '—'}</td>
            <td>
              <div class="coin-cell" data-tooltip="Нажмите для деталей">
                <img src="${coin.image}" alt="${coin.name}" class="coin-icon"
                     onerror="this.src='https://via.placeholder.com/32/333/fff?text=${coin.symbol.charAt(0)}'">
                <div class="coin-name-symbol">
                  <div class="coin-name">${coin.name}</div>
                  <div class="coin-symbol">${coin.symbol}</div>
                </div>
              </div>
            </td>
            <td style="font-weight: 600;">${formatter.currency(coin.current_price)}</td>
            <td class="${changeClass}" style="font-weight: 600;">
              ${formatter.percentage(change24h)}
            </td>
            <td>${formatter.currency(coin.market_cap)}</td>
            <td>${formatter.currency(coin.total_volume)}</td>
            <td>
              <div class="sparkline-container" data-tooltip="7-дневный график">
                ${sparkline}
              </div>
            </td>
            <td>
              <div class="badges">
                <span class="badge">${coin.symbol}</span>
                ${coin.price_change_percentage_7d_in_currency ? 
                  `<span class="badge ${coin.price_change_percentage_7d_in_currency >= 0 ? 'price-up' : 'price-down'}">
                    7д ${formatter.percentage(coin.price_change_percentage_7d_in_currency)}
                  </span>` : ''
                }
              </div>
            </td>
            <td>
              <button class="fav-star ${isFavorite ? 'active' : ''}" 
                      data-coin-id="${coin.id}"
                      data-tooltip="${isFavorite ? t.removeFromFavorites : t.addToFavorites}">
                <i class="fas fa-star"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
      
      // Add event listeners
      addTableEventListeners();
    }
    
    function createSparkline(prices) {
      if (!prices || prices.length < 2) {
        return '<div style="color: var(--muted); font-size: 11px; display: flex; align-items: center; justify-content: center; height: 100%;">Нет данных</div>';
      }
      
      const width = 120;
      const height = 40;
      const min = Math.min(...prices);
      const max = Math.max(...prices);
      const range = max - min || 1;
      
      const isPositive = prices[prices.length - 1] > prices[0];
      const color = isPositive ? 'var(--green)' : 'var(--red)';
      
      let path = `M 0 ${height - ((prices[0] - min) / range) * height}`;
      
      for (let i = 1; i < prices.length; i++) {
        const x = (i / (prices.length - 1)) * width;
        const y = height - ((prices[i] - min) / range) * height;
        path += ` L ${x} ${y}`;
      }
      
      return `
        <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}"
             preserveAspectRatio="none">
          <defs>
            <linearGradient id="sparkline-gradient-${Date.now()}-${Math.random()}" 
                            x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="${color}" stop-opacity="0.3" />
              <stop offset="100%" stop-color="${color}" stop-opacity="0" />
            </linearGradient>
          </defs>
          <path d="${path}" 
                fill="none" 
                stroke="${color}" 
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"/>
          <path d="${path} L ${width} ${height} L 0 ${height} Z" 
                fill="url(#sparkline-gradient-${Date.now()}-${Math.random()})"/>
        </svg>
      `;
    }
    
    function addTableEventListeners() {
      // Coin click
      document.querySelectorAll('.coin-cell').forEach(cell => {
        cell.addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          const coinId = row.dataset.coinId;
          openModal(coinId);
        });
      });
      
      // Favorite toggle
      document.querySelectorAll('.fav-star').forEach(star => {
        star.addEventListener('click', (e) => {
          e.stopPropagation();
          const coinId = star.dataset.coinId;
          toggleFavorite(coinId);
        });
      });
      
      // Header sorting
      document.querySelectorAll('thead th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const sortKey = th.dataset.sort;
          toggleSort(sortKey);
        });
      });
    }
    
    function toggleFavorite(coinId) {
      if (state.favorites.has(coinId)) {
        state.favorites.delete(coinId);
      } else {
        state.favorites.add(coinId);
      }
      
      localStorage.setItem('cryptoHubFavorites', JSON.stringify([...state.favorites]));
      
      // Update UI
      if (state.showFavorites) {
        applyFilters();
      } else {
        renderTable();
      }
      
      // Update modal if open
      if (state.currentModalCoin === coinId) {
        updateModalFavoriteButton();
      }
      
      // Show notification
      const t = texts[state.language];
      const coin = state.coins.find(c => c.id === coinId);
      const message = state.favorites.has(coinId) 
        ? `${coin?.name || 'Монета'} добавлена в избранное` 
        : `${coin?.name || 'Монета'} удалена из избранного`;
      
      showNotification(message, 'info');
    }
    
    function toggleSort(sortKey) {
      const isAsc = state.sortBy === `${sortKey}_asc`;
      state.sortBy = isAsc ? `${sortKey}_desc` : `${sortKey}_asc`;
      
      localStorage.setItem('cryptoHubSort', state.sortBy);
      
      // Update UI
      document.querySelectorAll('thead th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
        if (th.dataset.sort === sortKey) {
          th.classList.add(isAsc ? 'sort-desc' : 'sort-asc');
        }
      });
      
      elements.sort.value = state.sortBy;
      applyFilters();
    }
    
    function updatePagination() {
      const totalPages = Math.ceil(state.filteredCoins.length / state.pageSize);
      const t = texts[state.language];
      
      elements.pageInfo.textContent = 
        `${t.page} ${state.currentPage} ${t.of} ${totalPages}`;
      elements.totalCoins.textContent = 
        `${formatter.number(state.filteredCoins.length)} ${t.coins}`;
      
      // Update button states
      elements.firstPage.disabled = state.currentPage <= 1;
      elements.prevPage.disabled = state.currentPage <= 1;
      elements.nextPage.disabled = state.currentPage >= totalPages;
      elements.lastPage.disabled = state.currentPage >= totalPages;
    }
    
    // ===== MODAL FUNCTIONS =====
    
    async function openModal(coinId) {
      try {
        state.currentModalCoin = coinId;
        elements.modalBackdrop.style.display = 'flex';
        
        // Find coin in cache
        const coin = state.coins.find(c => c.id === coinId);
        if (!coin) {
          showNotification('Монета не найдена', 'error');
          return;
        }
        
        // Set basic info
        elements.modalIcon.src = coin.image;
        elements.modalIcon.onerror = () => {
          elements.modalIcon.src = `https://via.placeholder.com/48/333/fff?text=${coin.symbol.charAt(0)}`;
        };
        
        elements.modalTitle.textContent = coin.name;
        elements.modalSymbol.textContent = `#${coin.market_cap_rank || '—'} • ${coin.symbol}`;
        
        elements.mPrice.textContent = formatter.currency(coin.current_price);
        elements.mChange.textContent = formatter.percentage(coin.price_change_percentage_24h);
        elements.mChange.className = `stat-value ${coin.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down'}`;
        elements.mCap.textContent = formatter.currency(coin.market_cap);
        elements.mVol.textContent = formatter.currency(coin.total_volume);
        
        // Load detailed info
        const details = await apiService.getCoinDetails(coinId);
        
        // Update details
        elements.mRank.textContent = details.market_cap_rank || '—';
        elements.mSupply.textContent = details.market_data?.circulating_supply 
          ? formatter.compactNumber(details.market_data.circulating_supply) 
          : '—';
        elements.mMaxSupply.textContent = details.market_data?.max_supply 
          ? formatter.compactNumber(details.market_data.max_supply) 
          : '—';
        elements.mAth.textContent = details.market_data?.ath?.usd 
          ? formatter.currency(details.market_data.ath.usd) 
          : '—';
        
        // Description
        const description = details.description?.ru || details.description?.en || 'Описание недоступно';
        elements.mDescription.innerHTML = `
          <div style="max-height: 200px; overflow-y: auto; padding-right: 8px;">
            ${description.replace(/\n/g, '<br>')}
          </div>
        `;
        
        // Links
        const linksHtml = [];
        const linkTypes = {
          homepage: { icon: 'fas fa-home', label: 'Сайт' },
          blockchain_site: { icon: 'fas fa-link', label: 'Blockchain' },
          official_forum_url: { icon: 'fas fa-comments', label: 'Форум' },
          subreddit_url: { icon: 'fab fa-reddit', label: 'Reddit' },
          twitter_screen_name: { icon: 'fab fa-twitter', label: 'Twitter' }
        };
        
        for (const [key, info] of Object.entries(linkTypes)) {
          let url;
          if (key === 'twitter_screen_name') {
            const username = details.links[key];
            if (username) {
              url = `https://twitter.com/${username}`;
            }
          } else {
            const urls = details.links[key];
            if (urls && urls[0]) {
              url = urls[0];
            }
          }
          
          if (url) {
            linksHtml.push(`
              <a href="${url}" target="_blank" rel="noopener noreferrer" 
                 class="badge" style="text-decoration: none; display: flex; align-items: center; gap: 6px;">
                <i class="${info.icon}"></i>
                <span>${info.label}</span>
              </a>
            `);
          }
        }
        
        elements.mLinks.innerHTML = linksHtml.length 
          ? linksHtml.join('')
          : '<span class="badge">Ссылки не найдены</span>';
        
        // TradingView chart
        renderTradingViewChart(coin.symbol);
        
        // Update buttons
        updateModalButtons();
        
      } catch (error) {
        console.error('Error opening modal:', error);
        elements.mDescription.textContent = 'Ошибка загрузки данных. Попробуйте обновить страницу.';
      }
    }
    
    function renderTradingViewChart(symbol) {
      // Clean previous widget
      elements.tvWidget.innerHTML = '';
      
      // Check if TradingView is available
      if (typeof TradingView === 'undefined') {
        elements.tvWidget.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--muted);">
            <div style="text-align: center;">
              <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 16px;"></i>
              <p>График временно недоступен</p>
            </div>
          </div>
        `;
        return;
      }
      
      // Map symbols to TradingView format
      const tvSymbolMap = {
        'BTC': 'BINANCE:BTCUSDT',
        'ETH': 'BINANCE:ETHUSDT',
        'BNB': 'BINANCE:BNBUSDT',
        'SOL': 'BINANCE:SOLUSDT',
        'XRP': 'BINANCE:XRPUSDT',
        'ADA': 'BINANCE:ADAUSDT',
        'AVAX': 'BINANCE:AVAXUSDT',
        'DOT': 'BINANCE:DOTUSDT',
        'DOGE': 'BINANCE:DOGEUSDT',
        'MATIC': 'BINANCE:MATICUSDT',
        'SHIB': 'BINANCE:SHIBUSDT',
        'LINK': 'BINANCE:LINKUSDT',
        'UNI': 'BINANCE:UNIUSDT'
      };
      
      const tvSymbol = tvSymbolMap[symbol] || `COINBASE:${symbol}USD`;
      
      // Create new widget
      if (state.tvWidget) {
        state.tvWidget.remove();
      }
      
      state.tvWidget = new TradingView.widget({
        container_id: 'tvWidget',
        width: '100%',
        height: 200,
        symbol: tvSymbol,
        interval: 'D',
        timezone: 'Etc/UTC',
        theme: state.chartTheme,
        style: '1',
        locale: state.language === 'ru' ? 'ru' : 'en',
        toolbar_bg: '#f1f3f6',
        enable_publishing: false,
        hide_side_toolbar: false,
        allow_symbol_change: true,
        details: true,
        hotlist: false,
        calendar: false,
        studies: ['Volume@tv-basicstudies'],
        show_popup_button: true,
        popup_width: '1000',
        popup_height: '650'
      });
    }
    
    function updateModalButtons() {
      const t = texts[state.language];
      const isFavorite = state.currentModalCoin && state.favorites.has(state.currentModalCoin);
      
      elements.modalFavToggle.innerHTML = `
        <i class="fas fa-star"></i> 
        ${isFavorite ? t.removeFromFavorites : t.addToFavorites}
      `;
      
      elements.modalTheme.innerHTML = `
        <i class="fas ${state.chartTheme === 'dark' ? 'fa-moon' : 'fa-sun'}"></i> 
        ${state.chartTheme === 'dark' ? t.lightTheme : t.darkTheme}
      `;
      
      elements.modalRefresh.innerHTML = `
        <i class="fas fa-sync-alt"></i> ${t.retry}
      `;
    }
    
    function updateModalFavoriteButton() {
      if (!state.currentModalCoin) return;
      
      const t = texts[state.language];
      const isFavorite = state.favorites.has(state.currentModalCoin);
      
      elements.modalFavToggle.innerHTML = `
        <i class="fas fa-star"></i> 
        ${isFavorite ? t.removeFromFavorites : t.addToFavorites}
      `;
    }
    
    function closeModal() {
      elements.modalBackdrop.style.display = 'none';
      state.currentModalCoin = null;
      
      // Remove TradingView widget
      if (state.tvWidget) {
        state.tvWidget.remove();
        state.tvWidget = null;
      }
    }
    
    // ===== UTILITY FUNCTIONS =====
    
    async function refreshData() {
      try {
        if (state.isLoading) return;
        
        state.isLoading = true;
        await Promise.all([
          loadGlobalStats(),
          loadCoins()
        ]);
        
        applyFilters();
        
        // Show update notification
        showNotification('Данные обновлены', 'success');
        
      } catch (error) {
        console.error('Error refreshing data:', error);
        showNotification('Ошибка обновления данных', 'error');
      } finally {
        state.isLoading = false;
      }
    }
    
    function showNotification(message, type = 'info') {
      // Remove existing notifications
      document.querySelectorAll('.notification').forEach(n => n.remove());
      
      // Create new notification
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 
                          type === 'error' ? 'exclamation-circle' : 
                          'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'slideInUp 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // ===== EVENT LISTENERS =====
    
    function addEventListeners() {
      // Search
      elements.search.addEventListener('input', debounce((e) => {
        state.searchQuery = e.target.value.trim();
        state.currentPage = 1;
        applyFilters();
        
        // Show search suggestions
        if (state.searchQuery) {
          showSearchSuggestions();
        } else {
          elements.searchResults.style.display = 'none';
        }
      }, 300));
      
      // Theme toggle
      elements.toggleTheme.addEventListener('click', () => {
        const newTheme = state.theme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
      });
      
      // Favorites toggle
      elements.favOnly.addEventListener('change', (e) => {
        state.showFavorites = e.target.checked;
        localStorage.setItem('cryptoHubShowFav', state.showFavorites);
        state.currentPage = 1;
        applyFilters();
      });
      
      // Sort select
      elements.sort.addEventListener('change', (e) => {
        state.sortBy = e.target.value;
        localStorage.setItem('cryptoHubSort', state.sortBy);
        applyFilters();
      });
      
      // Language select
      elements.language.addEventListener('change', (e) => {
        applyLanguage(e.target.value);
        applyFilters();
      });
      
      // Pagination
      elements.firstPage.addEventListener('click', () => {
        state.currentPage = 1;
        applyFilters();
        scrollToTop();
      });
      
      elements.prevPage.addEventListener('click', () => {
        if (state.currentPage > 1) {
          state.currentPage--;
          applyFilters();
          scrollToTop();
        }
      });
      
      elements.nextPage.addEventListener('click', () => {
        const totalPages = Math.ceil(state.filteredCoins.length / state.pageSize);
        if (state.currentPage < totalPages) {
          state.currentPage++;
          applyFilters();
          scrollToTop();
        }
      });
      
      elements.lastPage.addEventListener('click', () => {
        const totalPages = Math.ceil(state.filteredCoins.length / state.pageSize);
        state.currentPage = totalPages;
        applyFilters();
        scrollToTop();
      });
      
      // Modal
      elements.closeModal.addEventListener('click', closeModal);
      elements.modalBackdrop.addEventListener('click', (e) => {
        if (e.target === elements.modalBackdrop) {
          closeModal();
        }
      });
      
      elements.modalFavToggle.addEventListener('click', () => {
        if (state.currentModalCoin) {
          toggleFavorite(state.currentModalCoin);
        }
      });
      
      elements.modalTheme.addEventListener('click', () => {
        state.chartTheme = state.chartTheme === 'dark' ? 'light' : 'dark';
        if (state.currentModalCoin) {
          const coin = state.coins.find(c => c.id === state.currentModalCoin);
          if (coin) {
            renderTradingViewChart(coin.symbol);
            updateModalButtons();
          }
        }
      });
      
      elements.modalRefresh.addEventListener('click', () => {
        if (state.currentModalCoin) {
          openModal(state.currentModalCoin);
        }
      });
      
      elements.openOnCG.addEventListener('click', () => {
        if (state.currentModalCoin) {
          window.open(`https://www.coingecko.com/coins/${state.currentModalCoin}`, '_blank');
        }
      });
      
      elements.copySymbol.addEventListener('click', async () => {
        if (state.currentModalCoin) {
          const coin = state.coins.find(c => c.id === state.currentModalCoin);
          if (coin) {
            try {
              await navigator.clipboard.writeText(coin.symbol);
              showNotification('Тикер скопирован в буфер обмена', 'success');
            } catch (err) {
              showNotification('Не удалось скопировать', 'error');
            }
          }
        }
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeModal();
        }
        if (e.key === 'r' && e.ctrlKey) {
          e.preventDefault();
          refreshData();
        }
      });
      
      // Hide search results on outside click
      document.addEventListener('click', (e) => {
        if (!elements.search.contains(e.target) && !elements.searchResults.contains(e.target)) {
          elements.searchResults.style.display = 'none';
        }
      });
    }
    
    function showSearchSuggestions() {
      if (!state.searchQuery) {
        elements.searchResults.style.display = 'none';
        return;
      }
      
      const suggestions = state.coins
        .filter(coin => 
          coin.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
          coin.symbol.toLowerCase().includes(state.searchQuery.toLowerCase())
        )
        .slice(0, 8);
      
      if (suggestions.length === 0) {
        elements.searchResults.innerHTML = `
          <div class="search-result-item" style="justify-content: center; color: var(--muted);">
            <i class="fas fa-search"></i>
            <div>${texts[state.language].noResults}</div>
          </div>
        `;
        elements.searchResults.style.display = 'block';
        return;
      }
      
      elements.searchResults.innerHTML = suggestions.map(coin => `
        <div class="search-result-item" data-coin-id="${coin.id}">
          <img src="${coin.image}" alt="${coin.name}" 
               onerror="this.src='https://via.placeholder.com/28/333/fff?text=${coin.symbol.charAt(0)}'">
          <div class="coin-info">
            <div class="coin-name">${coin.name}</div>
            <div class="coin-symbol">${coin.symbol}</div>
          </div>
          <div class="coin-price ${coin.price_change_percentage_24h >= 0 ? 'price-up' : 'price-down'}">
            ${formatter.currency(coin.current_price)}
          </div>
        </div>
      `).join('');
      
      elements.searchResults.style.display = 'block';
      
      // Add click handlers
      document.querySelectorAll('.search-result-item').forEach(item => {
        item.addEventListener('click', () => {
          const coinId = item.dataset.coinId;
          elements.search.value = '';
          elements.searchResults.style.display = 'none';
          openModal(coinId);
        });
      });
    }
    
    // ===== INITIALIZATION =====
    
    window.addEventListener('DOMContentLoaded', () => {
      init();
      addEventListeners();
      
      // Apply saved settings to UI
      elements.sort.value = state.sortBy;
      elements.favOnly.checked = state.showFavorites;
      elements.language.value = state.language;
      
      // Set initial styles for loading overlay
      elements.loadingOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
      `;
    });
    
    // ===== GLOBAL EXPORTS =====
    window.cryptoHub = {
      refreshData,
      toggleTheme: () => {
        const newTheme = state.theme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
      },
      openModal,
      closeModal,
      showNotification,
      state
    };
    
  })();
  </script>
</body>
</html>

name: Update cryptocurrency data snapshots

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      full_sync:
        description: 'Perform full sync (download all logos)'
        default: false
        type: boolean
      coins_limit:
        description: 'Number of coins to update'
        default: 50
        type: number
      force:
        description: 'Force update even if no changes'
        default: false
        type: boolean
  schedule:
    # Run every 30 minutes
    - cron: "*/30 * * * *"
    # Additional daily full sync at 2 AM UTC
    - cron: "0 2 * * *"

env:
  NODE_VERSION: '20'
  DATA_DIR: './data'
  ASSETS_DIR: './assets/img/coins'

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check workflow requirements
        id: check
        run: |
          SHOULD_RUN=true
          
          # Skip if secrets are not configured
          if [[ -z "${{ secrets.CMC_PRO_API_KEY }}" ]]; then
            echo "CMC_PRO_API_KEY is not set. Skipping workflow."
            SHOULD_RUN=false
          fi
          
          echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
          echo "Should run: $SHOULD_RUN"

  update-data:
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.should_run == 'true'
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Убираем cache отсюда, так как будем использовать свой cache

      - name: Cache npm dependencies
        if: hashFiles('package-lock.json') != ''
        uses: actions/cache@v3
        id: npm-cache
        with:
          path: |
            ~/.npm
            **/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: hashFiles('package.json') != ''
        run: |
          echo "Installing dependencies..."
          if [ -f "package-lock.json" ]; then
            npm ci --no-audit --no-fund --silent
          else
            npm install --no-audit --no-fund --silent
          fi

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Pull latest changes
        run: |
          echo "Pulling latest changes from main..."
          git pull origin main --ff-only || echo "Fast-forward not possible, continuing with current state"

      - name: Create directories if they don't exist
        run: |
          mkdir -p ${{ env.DATA_DIR }} ${{ env.ASSETS_DIR }}
          echo "Directories created/verified"

      - name: Run data update script
        id: update
        env:
          CMC_API_KEY: ${{ secrets.CMC_PRO_API_KEY }}
          COINS_LIMIT: ${{ github.event.inputs.coins_limit || 50 }}
          FULL_SYNC: ${{ github.event.inputs.full_sync || false }}
          NODE_ENV: 'production'
        run: |
          echo "Starting data update..."
          echo "Coins limit: $COINS_LIMIT"
          echo "Full sync: $FULL_SYNC"
          
          # Check if update script exists
          if [ ! -f "scripts/update-data.js" ]; then
            echo "Error: update-data.js not found in scripts/"
            echo "Available files in scripts/:"
            ls -la scripts/ 2>/dev/null || echo "scripts/ directory not found"
            exit 1
          fi
          
          # Run the update script
          node scripts/update-data.js
          
          # Count files
          DATA_FILES_COUNT=$(find ${{ env.DATA_DIR }} -type f -name "*.json" 2>/dev/null | wc -l || echo "0")
          LOGO_FILES_COUNT=$(find ${{ env.ASSETS_DIR }} -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.svg" \) 2>/dev/null | wc -l || echo "0")
          
          echo "data_files=$DATA_FILES_COUNT" >> $GITHUB_OUTPUT
          echo "logo_files=$LOGO_FILES_COUNT" >> $GITHUB_OUTPUT
          echo "::notice::Updated $DATA_FILES_COUNT data files and $LOGO_FILES_COUNT logo files"

      - name: Check for changes
        id: changes
        run: |
          echo "Checking git status..."
          git status
          
          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Show what changed
            echo "Changed files:"
            git diff --name-only
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Add only the data and assets directories
          git add ${{ env.DATA_DIR }} ${{ env.ASSETS_DIR }} || echo "No files to add in specified directories"
          
          # Check if we have anything to commit
          if git diff --cached --quiet; then
            echo "No changes to commit after filtering directories"
            exit 0
          fi
          
          # Create commit message
          COMMIT_MSG="chore: update cryptocurrency data"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            COMMIT_MSG="$COMMIT_MSG (manual)"
            if [[ "${{ github.event.inputs.full_sync }}" == "true" ]]; then
              COMMIT_MSG="$COMMIT_MSG - full sync"
            fi
          else
            COMMIT_MSG="$COMMIT_MSG (scheduled)"
          fi
          
          COMMIT_MSG="$COMMIT_MSG\n\n[skip ci]"
          
          # Commit
          echo "Committing changes..."
          echo -e "$COMMIT_MSG" | git commit -F -
          
          # Push with retry logic
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Push attempt $i/$MAX_RETRIES..."
            
            # Pull latest changes first
            git pull --rebase origin main || {
              echo "Rebase failed, resetting..."
              git rebase --abort
              git reset --hard origin/main
              git pull origin main
            }
            
            # Try to push
            if git push origin HEAD:main; then
              echo "Push successful!"
              break
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo "Failed to push after $MAX_RETRIES attempts"
              exit 1
            fi
            
            echo "Push failed, retrying in 5 seconds..."
            sleep 5
          done

      - name: Create summary
        if: always()
        run: |
          echo "## Data Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.changes.outputs.has_changes }}" == "true" ]]; then
            echo "✅ **Successfully updated and pushed data**" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.changes.outputs.has_changes }}" == "false" ]]; then
            echo "ℹ️ **No changes detected** - Data is already up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "❓ **Status unknown**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Data files: ${{ steps.update.outputs.data_files || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- Logo files: ${{ steps.update.outputs.logo_files || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "- Coins limit: ${{ github.event.inputs.coins_limit || 50 }}" >> $GITHUB_STEP_SUMMARY
            echo "- Full sync: ${{ github.event.inputs.full_sync || false }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Run ID: \`${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Run number: \`${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY

  notify:
    needs: update-data
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 2
    steps:
      - name: Print final status
        run: |
          echo "========================================"
          echo "WORKFLOW COMPLETED"
          echo "========================================"
          echo "Update job result: ${{ needs.update-data.result }}"
          echo "Run URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "========================================"
          
          if [[ "${{ needs.update-data.result }}" == "success" ]]; then
            echo "✅ All steps completed successfully"
          elif [[ "${{ needs.update-data.result }}" == "failure" ]]; then
            echo "❌ Workflow failed"
            echo "Check the logs for details"
          else
            echo "⚠️ Workflow completed with status: ${{ needs.update-data.result }}"
          fi

name: Update Crypto Data

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update even if recently updated'
        required: false
        default: 'false'

env:
  NODE_VERSION: '18'

# –ù—É–∂–Ω–æ –¥–ª—è push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Å–æ–∑–¥–∞–Ω–∏—è issue –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏.
permissions:
  contents: write
  issues: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    # –ß—Ç–æ–±—ã –∫—Ä–æ–Ω-–¥–∂–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∏ –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º.
    concurrency:
      group: update-data-${{ github.ref }}
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –£ –Ω–∞—Å –Ω–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π npm (—Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ Node),
      # –ø–æ—ç—Ç–æ–º—É –∫—ç—à npm –∏ npm install –Ω–µ –Ω—É–∂–Ω—ã. –ò–Ω–∞—á–µ setup-node –ø–∞–¥–∞–µ—Ç –±–µ–∑ lock-—Ñ–∞–π–ª–∞.
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Sync with remote
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git pull --rebase origin "${{ github.event.repository.default_branch }}"

      - name: Update crypto data
        env:
          CMC_PRO_API_KEY: ${{ secrets.CMC_PRO_API_KEY }}
          CRYPTOPANIC_API_KEY: ${{ secrets.CRYPTOPANIC_API_KEY }}
          PAGE_SIZE: 100
          MAX_COINS: 500
        run: |
          node scripts/update-data.js

      - name: Commit and push changes
        run: |
          # –î–∞–Ω–Ω—ã–µ
          git add -A data
          # –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –º–æ–Ω–µ—Ç (–µ—Å–ª–∏ –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –ø–æ—è–≤—è—Ç—Å—è)
          git add -A assets/img/coins || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "üìä Update crypto data [$(date -u +'%Y-%m-%d %H:%M UTC')]"
          git push origin "HEAD:${{ github.event.repository.default_branch }}"

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            await github.rest.issues.create({
              owner,
              repo,
              title: 'Data update failed',
              body: 'The scheduled data update workflow has failed. Please check the logs.',
              labels: ['bug', 'data-update']
            });

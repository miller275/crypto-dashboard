import { Utils } from "./utils.js";

/**
 * GitHub Pages mode:
 *  - Browser NEVER calls public APIs.
 *  - All data is read from /data snapshots (generated by GitHub Actions).
 */
const PATHS = {
  markets: "data/markets.latest.json",
  fng: "data/fear-greed.latest.json",
  news: "data/news.latest.json",
  coin: (id) => `data/coins/${encodeURIComponent(id)}.json`,
  marketChart: (id, days) => `data/market_chart/${encodeURIComponent(id)}-${encodeURIComponent(days)}.json`,
  ohlc: (id, days) => `data/ohlc/${encodeURIComponent(id)}-${encodeURIComponent(days)}.json`
};

async function fetchJSON(url, {timeoutMs=12000}={}){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, { signal: controller.signal, cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${url}`);
    return await res.json();
  }finally{
    clearTimeout(t);
  }
}

async function trySnapshot(url){
  try{
    return await fetchJSON(url);
  }catch(_){
    return null;
  }
}

export const API = {
  async loadMarkets(){
    const snap = await trySnapshot(PATHS.markets);
    if (!snap || !Array.isArray(snap.coins)){
      throw new Error("Missing data/markets.latest.json. Run GitHub Action: Update data snapshots (CMC).");
    }
    return { source: snap.source || "snapshot", updatedAt: snap.updatedAt, coins: snap.coins, global: snap.global || null };
  },

  async loadFearGreed(){
    const snap = await trySnapshot(PATHS.fng);
    if (!snap) return { source: "snapshot", data: [], updatedAt: null };
    return snap;
  },

  async loadNews(){
    const snap = await trySnapshot(PATHS.news);
    if (!snap) return { source: "snapshot", items: [], updatedAt: null };
    return snap;
  },

  async loadCoinDetails(id){
    const snap = await trySnapshot(PATHS.coin(id));
    if (!snap) throw new Error(`No snapshot for coin id=${id}.`);
    return { source: "snapshot", data: snap };
  },

  async loadMarketChart(id, days){
    const snap = await trySnapshot(PATHS.marketChart(id, days));
    if (!snap) throw new Error(`No market chart snapshot for ${id}-${days}.`);
    return { source: "snapshot", data: snap };
  },

  async loadOHLC(id, days){
    const snap = await trySnapshot(PATHS.ohlc(id, days));
    if (Array.isArray(snap)) return { source: "snapshot", data: snap };
    throw new Error(`No OHLC snapshot for ${id}-${days}.`);
  }
};
